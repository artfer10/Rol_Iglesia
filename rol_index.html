<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Iglesia</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <!--Estilo-->
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
    
      padding: 2rem;
    }

    #calendar-container {
      max-width: auto;
      margin: auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      overflow: visible;
    }


    .fc .fc-toolbar-title {
      font-size: 1rem;
      font-weight: bold;
      color: #007bff;
    }

    .fc .fc-button {
      background-color: #007bff;
      border: none;
      width: 35px;
      height: 35px;
      padding: 0;
    }

    .fc .fc-button:hover {
      background-color: #0056b3;
    }

    .fc .fc-button .fc-icon {
      font-size: 1rem;
    }

    .fc-daygrid-day-number {
      font-weight: bold;
    }

    .fc-daygrid-day.fc-day-today {
      background-color: #e6f7ff;
      border-radius: 50%;
    }

    @media (max-width: 500px) {
      .fc-event-title {
        white-space: normal;
      }

      .fc-daygrid-day-number {
        font-size: 0.75rem;
      }

      .fc-event-title {
        font-size: 0.7rem;
        line-height: 1.2;
        padding: 2px;
      }
    }
  </style>
</head>

<body>
  <div class="container mb-4 text-center">
    <h2 class="fw-bold">Rol Iglesia Adventista Jutiapa Centro</h2>
    <div class="input-group mt-3">
      <input type="text" id="nombre" class="form-control" maxlength="200" placeholder="Buscar participante">
      <button class="btn btn-primary" onclick="buscarNombre()">Buscar</button>
    </div>
  </div>

  <div class="text-center small" id="leyenda-familias"></div>

  <div id="calendar-container" class="mt-1">
    <div id="calendar"></div>
    <div class="text-center">
      <button class="btn btn-outline-primary btn-sm mt-2" onclick="irAHoy()">Ir a Hoy</button>
    </div>
  </div>

  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Detalles del Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="modal-body">
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    const programacion = [
      // Septiembre 2025
      //Domingo -Predicación - Aseo -Canto
      { dia: "2025-09-07", predicador: "Dony", aseo: "Mario - Lidia", canto: "Mayra"},
      { dia: "2025-09-14", predicador: "Liliana", aseo: "Belkis - Maylin", canto: "Dalila"},
      { dia: "2025-09-21", predicador: "Esau", aseo: "Luisa - Natividad", canto: "Mariangel"},
      { dia: "2025-09-28", predicador: "Said", aseo: "Flores Solorzano", canto: "Margareth"},

      //Miercoles -Predicación - Aseo -Canto
      { dia: "2025-09-03", predicador: "Juana", aseo: "Nimian", canto: "Maylin"},
      { dia: "2025-09-10", predicador: "Heydi", aseo: "Mario - Lidia", canto: "Joandri" },
      { dia: "2025-09-17", predicador: "Astrid", aseo: "Belkis - Maylin", canto: "Paulina"},
      { dia: "2025-09-24", predicador: "Margareth", aseo: "Luisa - Natividad", canto: "Nimian" },
      
      //Viernes - Jóvenes - Aseo
      { dia: "2025-09-05", jovenes: "No asignado", aseo: "Nimian" },
      { dia: "2025-09-12", jovenes: "No asignado", aseo: "Mario - Lidia" },
      { dia: "2025-09-19", jovenes: "No asignado", aseo: "Belkis - Maylin" },
      { dia: "2025-09-26", jovenes: "No asignado", aseo: "Luisa - Natividad" },
      
      //Sabado - Predicación - Canto - Escuela Sabática
      { dia: "2025-09-06", predicador: "Mario Reyes", canto: "Halbin", escuela_sabatica: "No asignado" },
      { dia: "2025-09-13", predicador: "Karen", canto: "Delmer", escuela_sabatica: "No asignado" },
      { dia: "2025-09-20", predicador: "Delmer", canto: "Rosita", escuela_sabatica: "No asignado" },
      { dia: "2025-09-27", predicador: "Britny", canto: "Rudy", escuela_sabatica: "No asignado" },


    ];

    const colorPorFamilia = {
      "Nimian": "#ffc107",
      "Mario - Lidia": "#007bff",
      "Belkis - Maylin": "#FF8904",
      "Luisa - Natividad": "#28a745",
      "Flores Solorzano": "#dc3545",
      
    };

    // Semana del mes empezando en domingo
    function getWeekOfMonth(date) {
      const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
      const firstDayWeekDay = firstDay.getDay(); // 0=domingo
      const day = date.getDate();
      return Math.floor((day + firstDayWeekDay - 1) / 7);
    }

    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        themeSystem: 'bootstrap5',
        firstDay: 0,
        fixedWeekCount: false,

        contentHeight: 'auto',
        headerToolbar: {
          left: 'prev',
          center: 'title',
          right: 'next'
        },

        dayCellDidMount: function (info) {
          const fecha = new Date(info.date);
          const fechaStr = fecha.toISOString().slice(0, 10);
          // Busca si hay evento de aseo para ese día
          const evento = programacion.find(ev => ev.dia === fechaStr && ev.aseo);
          if (evento && evento.aseo) {
            const color = colorPorFamilia[evento.aseo] || '#bbb';
            info.el.style.borderBottom = `3px solid ${color}`;
            info.el.title = `Día de aseo: ${evento.aseo}`;
          }
        },

        events: programacion.map(ev => ({
          title: ev.predicador
            ? ev.predicador
            : (ev.jovenes ? ev.jovenes : 'Sin Asignación'),
          start: ev.dia,
          color: (!ev.predicador && ev.jovenes) ? '#dc3545' : undefined, 
          extendedProps: ev
        })),

        eventClick: function (info) {
          let event = info.event.extendedProps;
          const fecha = new Date(info.event.startStr + "T00:00");
          const fechaFormateada = fecha.toLocaleDateString('es-ES', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          });

          let detalle = "";

          // Sábado: Canto, Escuela Sabática
          if (fecha.getDay() === 6) { // Sábado
            if (event.canto) detalle += `<strong>Canto:</strong> ${event.canto}<br>`;
            if (event.escuela_sabatica) detalle += `<strong>Escuela Sabática:</strong> ${event.escuela_sabatica}<br>`;
            if (event.predicador) detalle += `<strong>Predicador:</strong> ${event.predicador}<br>`;
            if (event.aseo) detalle += `<div class="mt-2"><strong>Aseo:</strong> ${event.aseo}</div>`;
          }
          // Viernes: Jóvenes y Aseo
          else if (fecha.getDay() === 5) { // Viernes
            if (event.jovenes) detalle += `<strong>Sociedad de Jóvenes:</strong> ${event.jovenes}<br>`;
            if (event.aseo) detalle += `<div class="mt-2"><strong>Aseo:</strong> ${event.aseo}</div>`;
          }
          // Miércoles: Canto, Predicador, Aseo
          else if (fecha.getDay() === 3) { // Miércoles
            if (event.canto) detalle += `<strong>Canto:</strong> ${event.canto}<br>`;
            if (event.predicador) detalle += `<strong>Predicador:</strong> ${event.predicador}<br>`;
            if (event.aseo) detalle += `<div class="mt-2"><strong>Aseo:</strong> ${event.aseo}</div>`;
          }
          // Domingo y otros días: Predicador, Aseo, Canto
          else {
            if (event.predicador) detalle += `<strong>Predicador:</strong> ${event.predicador}<br>`;
            if (event.aseo) detalle += `<div class="mt-2"><strong>Aseo:</strong> ${event.aseo}</div>`;
            if (event.canto) detalle += `<strong>Canto:</strong> ${event.canto}<br>`;
          }

          document.getElementById('modal-body').innerHTML = detalle;
          document.getElementById('infoModalLabel').innerText = fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1);
          const modal = new bootstrap.Modal(document.getElementById('infoModal'));
          modal.show();
        }
      });

      calendar.render();
      window.calendar = calendar;

      // Actualiza simbología al cargar
      const fechaActual = calendar.getDate();
      actualizarSimbologia(fechaActual.getMonth(), fechaActual.getFullYear());
      // Actualiza simbología al cambiar de mes
      calendar.on('datesSet', function (info) {
        // Busca el primer día del mes realmente visible
        const fechaCentral = calendar.getDate(); // Esto da el mes principal mostrado
        actualizarSimbologia(fechaCentral.getMonth(), fechaCentral.getFullYear());
      });
    });


    function actualizarSimbologia(mes, anio) {
      let familiasMes = [];

      programacion.forEach(ev => {
        const fecha = new Date(ev.dia);
        if (
          fecha.getMonth() === mes &&
          fecha.getFullYear() === anio &&
          ev.aseo &&
          ev.aseo !== "No asignado"
        ) {
          familiasMes.push({ familia: ev.aseo, fecha });
        }
      });

      // Ordenar por fecha del evento
      familiasMes.sort((a, b) => a.fecha - b.fecha);

      // Quitar duplicados manteniendo el primero que aparece
      const familiasUnicas = [];
      const vistos = new Set();
      familiasMes.forEach(item => {
        if (!vistos.has(item.familia)) {
          vistos.add(item.familia);
          familiasUnicas.push(item.familia);
        }
      });

      // Renderizar leyenda
      const leyenda = familiasUnicas.length > 0
        ? familiasUnicas.map(fam =>
            `<span class="badge" style="background:${colorPorFamilia[fam] || '#bbb'};color:#222;margin:2px">${fam}</span>`
          ).join('')
        : '';

      document.getElementById('leyenda-familias').innerHTML = leyenda;
    }

    // Función para sacar el número de semana
    function getWeekNumber(date) {
      const onejan = new Date(date.getFullYear(), 0, 1);
      const millisecsInDay = 86400000;
      return Math.ceil((((date - onejan) / millisecsInDay) + onejan.getDay() + 1) / 7);
    }
    function formatoGoogleDate(fechaStr) {
      const date = new Date(fechaStr + 'T00:00:00Z');
      return date.toISOString().replace(/[-:]/g, '').split('.')[0].slice(0, 15) + 'Z';
    }


    function irAHoy() {
      window.calendar.today();
    }

    function buscarNombre() {
      const nombre = document.getElementById("nombre").value.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      if (nombre === "") {
        document.getElementById('resultado').innerText = "Por favor, ingrese un nombre.";
        return;
      }

      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);


      const coincidencias = programacion.filter(ev => {
        const diaEvento = new Date(ev.dia + "T00:00");
        return (
          diaEvento >= hoy && (
            (ev.predicador && ev.predicador.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre)) ||
            (ev.aseo && ev.aseo.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre)) ||
            (ev.canto && ev.canto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre)) ||
            (ev.escuela_sabatica && ev.escuela_sabatica.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre)) ||
            (ev.jovenes && ev.jovenes.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre))
          )
        );
      });
   

      if (coincidencias.length > 0) {
        // Define los roles y sus colores/íconos
        const roles = [
          { clave: "predicador", color: "#007bff", icono: "🟦", nombre: "Predicador" },
          { clave: "aseo", color: "#28a745", icono: "🧹", nombre: "Aseo" },
          { clave: "canto", color: "#ffc107", icono: "🟨", nombre: "Canto" },
          { clave: "escuela_sabatica", color: "#17a2b8", icono: "📘", nombre: "Escuela Sabática" },
          { clave: "jovenes", color: "#dc3545", icono: "🟥", nombre: "Jóvenes" }
        ];

        // Agrupa las fechas por rol
        let fechasPorRol = {};
        roles.forEach(rol => fechasPorRol[rol.clave] = []);

        coincidencias.forEach(ev => {
          const fecha = new Date(ev.dia + "T00:00").toLocaleDateString('es-ES', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          });
          roles.forEach(rol => {
            if (ev[rol.clave] && ev[rol.clave].toLowerCase().includes(nombre)) {
              fechasPorRol[rol.clave].push(fecha);
            }
          });
        });

        // Construye el contenido agrupado SIN iconos
        let contenido = "";
        roles.forEach(rol => {
          if (fechasPorRol[rol.clave].length > 0) {
            contenido += `<div class="mb-2" style="text-align:left;">
              <b style="color:${rol.color}">${rol.nombre}:</b>
              <ul style="margin-bottom:0;">${fechasPorRol[rol.clave].map(f => `<li>${f}</li>`).join('')}</ul>
            </div>`;
          }
        });

        // Botón para descargar .ics
        contenido += `<div class="d-flex justify-content-center mt-2">
          <button onclick="descargarICS('${nombre}')" class="btn btn-success btn-sm">Agregar a mi calendario</button>
        </div>`;

        document.getElementById('infoModalLabel').innerText = 'Asignaciones de ' + nombre.charAt(0).toUpperCase() + nombre.slice(1);
        document.getElementById('modal-body').innerHTML = contenido;
      } else {
        document.getElementById('infoModalLabel').innerText = 'Sin resultados';
        document.getElementById('modal-body').innerHTML = 'No se encontró el nombre ingresado.';
      }

      new bootstrap.Modal(document.getElementById('infoModal')).show();
    }

    // Genera y descarga un archivo .ics con todas las asignaciones encontradas
    function descargarICS(nombre) {
      const coincidencias = programacion.filter(ev =>
        (ev.predicador && ev.predicador.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre)) ||
        (ev.aseo && ev.aseo.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre)) ||
        (ev.canto && ev.canto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre)) ||
        (ev.escuela_sabatica && ev.escuela_sabatica.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre)) ||
        (ev.jovenes && ev.jovenes.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(nombre))
      );
      let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\n";
      coincidencias.forEach(ev => {
        let rol = "";
        if (ev.predicador && ev.predicador.toLowerCase().includes(nombre)) rol = `Predicador: ${ev.predicador}`;
        if (ev.aseo && ev.aseo.toLowerCase().includes(nombre)) rol = `Aseo: ${ev.aseo}`;
        if (ev.canto && ev.canto.toLowerCase().includes(nombre)) rol = `Canto: ${ev.canto}`;
        if (ev.escuela_sabatica && ev.escuela_sabatica.toLowerCase().includes(nombre)) rol = `Escuela Sabática: ${ev.escuela_sabatica}`;
        if (ev.jovenes && ev.jovenes.toLowerCase().includes(nombre)) rol = `Jóvenes: ${ev.jovenes}`;
        const fecha = ev.dia.replace(/-/g, "");
        ics += `BEGIN:VEVENT\nSUMMARY:${rol}\nDTSTART;VALUE=DATE:${fecha}\nDTEND;VALUE=DATE:${fecha}\nDESCRIPTION:Participación en Iglesia\nEND:VEVENT\n`;
      });
      ics += "END:VCALENDAR";
      const blob = new Blob([ics], { type: 'text/calendar' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "asignaciones.ics";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

  </script>
</body>

</html>